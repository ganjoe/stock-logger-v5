<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTA Real-Time Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            padding: 1rem 2rem;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ef4444;
        }

        .status-dot.connected {
            background-color: #22c55e;
            box-shadow: 0 0 8px #22c55e;
        }

        #chart-container {
            flex-grow: 1;
            padding: 1rem;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .badge {
            background: #334155;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
        }
    </style>
</head>

<body>
    <header>
        <div>
            <h1>PTA Execution Dashboard</h1>
            <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.2rem;" id="payload-info">Waiting for data...
            </div>
        </div>
        <div class="status">
            <div id="status-dot" class="status-dot"></div>
            <span id="status-text">Disconnected</span>
        </div>
    </header>

    <div id="debug-console"
        style="height: 150px; background: #000; overflow-y: scroll; padding: 0.5rem; font-family: monospace; font-size: 0.8rem; border-top: 1px solid #333;">
        <div>Debug Console:</div>
    </div>

    <div id="chart-container"></div>

    <script>
        function logDebug(msg) {
            const c = document.getElementById('debug-console');
            const d = document.createElement('div');
            d.innerText = new Date().toLocaleTimeString() + ': ' + msg;
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
            console.log(msg);
        }
        // Global Error Handler
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            logDebug('üö® Global Error: ' + msg);
            return false;
        };

        const container = document.getElementById('chart-container');
        let chart;
        try {
            chart = LightweightCharts.createChart(container, {
                layout: { background: { color: '#0f172a' }, textColor: '#94a3b8' },
                grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
                rightPriceScale: { borderColor: '#334155' },
                timeScale: { borderColor: '#334155', timeVisible: true, secondsVisible: false },
            });
        } catch (e) {
            logDebug('‚ùå Error initializing Chart: ' + e.message);
        }

        const areaSeries = chart ? chart.addAreaSeries({
            lineColor: '#3b82f6',
            topColor: 'rgba(59, 130, 246, 0.4)',
            bottomColor: 'rgba(59, 130, 246, 0.0)',
            lineWidth: 2,
        }) : null;

        // Resize handling
        window.addEventListener('resize', () => {
            if (chart) chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
        });

        // SSE Connection
        function connect() {
            logDebug('üöÄ v5.2 Script started. Connecting to /events...');

            // Use relative path - works better if hosted on localhost:8000
            const eventSource = new EventSource('/events');

            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');

            eventSource.onopen = () => {
                dot.classList.add('connected');
                text.innerText = 'Connected (SSE)';
                logDebug('‚úÖ SSE Connected to PTA Server');
            };

            eventSource.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                logDebug('üì© Received SSE: ' + msg.msg_type);

                if (msg.msg_type === 'CHART_UPDATE') {
                    document.getElementById('payload-info').innerText = 'Viewing: ' + msg.payload_type;

                    if (msg.data && msg.data.length > 0) {
                        // Trusting Backend for sorting and deduplication [Structural Fix 2026]
                        const chartData = msg.data.map(item => ({
                            time: item.t,
                            value: item.v || item.c || 0
                        }));

                        areaSeries.setData(chartData);
                        chart.timeScale().fitContent();
                        logDebug('üìä Chart updated with ' + chartData.length + ' points (Structural Integrity)');
                    } else {
                        logDebug('‚ö†Ô∏è Received empty data array');
                    }
                }
                else if (msg.msg_type === 'CLEAR') {
                    areaSeries.setData([]);
                    document.getElementById('payload-info').innerText = 'Waiting for data...';
                    logDebug('üßπ Chart cleared');
                }
            };

            eventSource.onerror = (err) => {
                logDebug('‚ùå SSE Error (Check Console for details)');
                console.error('SSE Error:', err);
                dot.classList.remove('connected');
                text.innerText = 'Disconnected';
            };
        }

        connect();
    </script>
</body>

</html>